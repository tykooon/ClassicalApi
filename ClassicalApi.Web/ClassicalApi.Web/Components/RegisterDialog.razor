@using ClassicalApi.Web.Client.Models
@using ClassicalApi.Web.Components.Account
@using ClassicalApi.Web.Data
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@inject DialogService dialogService
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<RadzenCard class="rz-my-4 rz-mx-auto rz-p-4 rz-p-md-12" style="max-width: 600px;">
    <RadzenTemplateForm Data=@("RegisterDefaultValues") >
        <RadzenFieldset Text="User Info" Style="min-width:300px;">
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">First Name</RadzenText>
            <RadzenTextBox Placeholder="First Name..." @bind-Value="registerInfo.FirstName" class="w-100 mb-3" aria-label="First Name"/>

            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Last Name</RadzenText>
            <RadzenTextBox Placeholder="Last Name..." @bind-Value="registerInfo.LastName" class="w-100 mb-3" aria-label="Last Name"/>

            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Email</RadzenText>
            <RadzenTextBox Placeholder="Email..." @bind-Value="registerInfo.LastName" class="w-100 mb-3" aria-label="Email"/>

            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Password</RadzenText>
            <RadzenPassword Placeholder="Password..." @bind-Value="registerInfo.Password" class="w-100 mb-3" aria-label="Password"/>

            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Password</RadzenText>
            <RadzenPassword Placeholder="Password..." @bind-Value="registerInfo.ConfirmPassword" class="w-100 mb-3" aria-label="PasswordConfirm" />


        </RadzenFieldset>
    </RadzenTemplateForm>
</RadzenCard>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private RegisterInfo registerInfo { get; set; } = new();

    string userName = "admin";
    string password = "admin";
    bool rememberMe = true;

    async Task OnLogin(LoginArgs args, string name)
    {
        var result = await SignInManager.PasswordSignInAsync(userName, password, rememberMe, lockoutOnFailure: false);
        if (result.Succeeded)
        {
            dialogService.Close(true);
        }
        // else if (result.RequiresTwoFactor)
        // {
        //     RedirectManager.RedirectTo(
        //         "Account/LoginWith2fa",
        //         new() { ["returnUrl"] = ReturnUrl, ["rememberMe"] = Input.RememberMe });
        // }
        // else if (result.IsLockedOut)
        // {
        //     Logger.LogWarning("User account locked out.");
        //     RedirectManager.RedirectTo("Account/Lockout");
        // }
        else
        {
            Console.WriteLine("Error: Invalid login attempt.");
            dialogService.Close(false);
        }
    }


    void OnRegister(string name)
    {
        dialogService.Close(true);

    }

    void OnResetPassword(string value, string name)
    {
        dialogService.Close(true);
    }

    protected override async Task OnInitializedAsync()
    {
        var flag = HttpContext?.Request?.Method;
        if (HttpMethods.IsGet(flag))
    {
            // Clear the existing external cookie to ensure a clean login process
            await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);
        }
    }
}
